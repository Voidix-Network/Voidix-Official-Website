name: Advanced PR Deployment Controller

on:
  issue_comment:
    types: [created]
  pull_request_target: # ä½¿ç”¨ pull_request_target ä»¥å®‰å…¨åœ°å¤„ç†æ ‡ç­¾å’Œè·å– PR è¯¦æƒ…
    types: [closed]

permissions:
  contents: read
  issues: write       # ç”¨äºè¯„è®º
  pull-requests: write # ç”¨äºæ·»åŠ /ç§»é™¤æ ‡ç­¾

jobs:
  # Job 1: å¤„ç† 'deploy' è¯„è®º
  handle_deploy_comment:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'deploy')
    runs-on: [self-hosted, website]
    outputs:
      should_deploy_immediately: ${{ steps.check_pr_status.outputs.deploy_now }}
      pr_number_for_immediate_deploy: ${{ steps.check_pr_status.outputs.pr_number }}
      commenter_login: ${{ steps.check_permissions.outputs.commenter }}

    steps:
      - name: Check Commenter Permissions
        id: check_permissions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const authorizedAssociations = ['OWNER', 'MEMBER'];
            const authorAssociation = context.payload.comment.author_association;
            const commenter = context.payload.comment.user.login;
            core.setOutput('commenter', commenter);

            if (!authorizedAssociations.includes(authorAssociation)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ @${commenter}, æ‚¨æ²¡æœ‰è¶³å¤Ÿçš„æƒé™ (éœ€è¦ OWNER æˆ– MEMBER) æ¥è§¦å‘éƒ¨ç½²ã€‚æ‚¨å½“å‰çš„å…³è”æ˜¯ï¼š${authorAssociation}ã€‚`
              });
              core.setFailed(`è¯„è®ºè€… @${commenter} (${authorAssociation}) æ— æƒæ“ä½œã€‚`);
              return;
            }
            console.log(`æˆæƒè¯„è®ºè€…: @${commenter} (${authorAssociation})`);

      - name: Get PR Details & Decide Action
        id: check_pr_status
        if: steps.check_permissions.outcome == 'success' # ä»…å½“æƒé™æ£€æŸ¥é€šè¿‡æ—¶è¿è¡Œ
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            core.setOutput('pr_number', prNumber);
            const commenter = '${{ steps.check_permissions.outputs.commenter }}';

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            if (pr.base.ref !== 'master') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `â„¹ï¸ @${commenter}, éƒ¨ç½²å‘½ä»¤ä»…é€‚ç”¨äºç›®æ ‡ä¸º \`master\` åˆ†æ”¯çš„ PRã€‚æ­¤ PR (#${prNumber}) çš„ç›®æ ‡æ˜¯ \`${pr.base.ref}\`ã€‚`
              });
              core.setFailed('PR æœªä»¥ master ä¸ºç›®æ ‡ã€‚');
              return;
            }

            if (pr.merged && pr.state === 'closed') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âœ… @${commenter}, PR #${prNumber} å·²åˆå¹¶åˆ° masterã€‚å°†ç«‹å³å¼€å§‹éƒ¨ç½² master åˆ†æ”¯...`
              });
              core.setOutput('deploy_now', 'true');
            } else if (pr.state === 'open') {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['deploy-when-merged']
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `â³ @${commenter}, å·²æ”¶åˆ°éƒ¨ç½² PR #${prNumber} çš„å‘½ä»¤ã€‚ç³»ç»Ÿå°†åœ¨ PR åˆå¹¶åˆ° master åè‡ªåŠ¨éƒ¨ç½²ã€‚\næ ‡ç­¾ 'deploy-when-merged' å·²æ·»åŠ ã€‚`
              });
              core.setOutput('deploy_now', 'false');
            } else { // PR å·²å…³é—­ä½†æœªåˆå¹¶
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `â„¹ï¸ @${commenter}, PR #${prNumber} å·²å…³é—­ä½†æœªåˆå¹¶åˆ° masterã€‚æ— æ³•éƒ¨ç½²ã€‚`
              });
              core.setFailed('PR å·²å…³é—­ä¸”æœªåˆå¹¶ã€‚');
            }

  # Job 2: å¦‚æœ 'deploy' è¯„è®ºåœ¨å·²åˆå¹¶çš„ PR ä¸Šï¼Œåˆ™ç«‹å³éƒ¨ç½² master
  deploy_master_immediately:
    needs: handle_deploy_comment
    if: success() && needs.handle_deploy_comment.outputs.should_deploy_immediately == 'true'
    runs-on: [self-hosted, website] # æ­¤ä½œä¸šåœ¨æ‚¨çš„è‡ªæ‰˜ç®¡ runner ä¸Šè¿è¡Œ
    steps:
      - name: Announce Immediate Deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.handle_deploy_comment.outputs.pr_number_for_immediate_deploy }},
              body: `ğŸš€ @${{ needs.handle_deploy_comment.outputs.commenter_login }}ï¼Œå¼€å§‹ç«‹å³éƒ¨ç½² master åˆ†æ”¯ (å›  PR #${{ needs.handle_deploy_comment.outputs.pr_number_for_immediate_deploy }} å·²åˆå¹¶)ã€‚\n[æŸ¥çœ‹ Workflow è¿è¡Œæƒ…å†µ](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
      
      - name: Deploy Master Branch (Immediate)
        shell: bash
        env:
          PR_NUMBER: ${{ needs.handle_deploy_comment.outputs.pr_number_for_immediate_deploy }}
        run: |
          echo "PR #${PR_NUMBER} (å·²åˆå¹¶) è§¦å‘ç«‹å³éƒ¨ç½² master åˆ†æ”¯..."
          echo "å¯¼èˆªåˆ° /var/www/voidix..."
          cd /var/www/voidix
          if [ $? -ne 0 ]; then echo "é”™è¯¯ï¼šæ— æ³•è¿›å…¥ç›®å½• /var/www/voidixã€‚"; exit 1; fi
          
          echo "ä» origin æ‹‰å– master åˆ†æ”¯çš„æœ€æ–°æ›´æ”¹..."
          git fetch origin master
          if [ $? -ne 0 ]; then echo "é”™è¯¯ï¼šgit fetch origin master å¤±è´¥ã€‚"; exit 1; fi
          
          echo "æ£€å‡ºå¹¶å°†æœ¬åœ° master åˆ†æ”¯é‡ç½®ä¸º origin/master..."
          git checkout -B master origin/master
          if [ $? -ne 0 ]; then echo "é”™è¯¯ï¼šgit checkout -B master origin/master å¤±è´¥ã€‚"; exit 1; fi
          echo "æˆåŠŸå°† /var/www/voidix æ›´æ–°åˆ° master åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚"
          
          echo "é‡æ–°åŠ è½½ Nginx..."
          sudo systemctl reload nginx
          if [ $? -ne 0 ]; then echo "é”™è¯¯ï¼šé‡æ–°åŠ è½½ Nginx å¤±è´¥ã€‚è¯·æ£€æŸ¥ sudo æƒé™ã€‚"; exit 1; fi
          echo "Nginx å·²æˆåŠŸé‡æ–°åŠ è½½ã€‚Master åˆ†æ”¯å·²éƒ¨ç½²å®Œæ¯•ã€‚"

      - name: Post Immediate Deployment Success Comment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.handle_deploy_comment.outputs.pr_number_for_immediate_deploy }},
              body: `ğŸ‰ @${{ needs.handle_deploy_comment.outputs.commenter_login }}ï¼Œç«‹å³éƒ¨ç½²æˆåŠŸï¼master åˆ†æ”¯å·²æ›´æ–° (å›  PR #${{ needs.handle_deploy_comment.outputs.pr_number_for_immediate_deploy }} åˆå¹¶)ã€‚\n[æŸ¥çœ‹ Workflow è¿è¡Œæ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });

      - name: Post Immediate Deployment Failure Comment
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.handle_deploy_comment.outputs.pr_number_for_immediate_deploy }},
              body: `ğŸ”¥ @${{ needs.handle_deploy_comment.outputs.commenter_login }}ï¼Œç«‹å³éƒ¨ç½²å¤±è´¥ï¼åœ¨æ›´æ–° master åˆ†æ”¯æ—¶å‘ç”Ÿé”™è¯¯ (å›  PR #${{ needs.handle_deploy_comment.outputs.pr_number_for_immediate_deploy }} åˆå¹¶)ã€‚\nè¯·æ£€æŸ¥ [Workflow è¿è¡Œæ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ã€‚`
            });

  # Job 3: å¦‚æœå¸¦æœ‰ 'deploy-when-merged' æ ‡ç­¾çš„ PR åˆå¹¶åˆ° masterï¼Œåˆ™éƒ¨ç½² master
  deploy_on_merge_if_labelled:
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'master' && contains(join(github.event.pull_request.labels.*.name, ','), 'deploy-when-merged')
    runs-on: [self-hosted, website] # æ­¤ä½œä¸šåœ¨æ‚¨çš„è‡ªæ‰˜ç®¡ runner ä¸Šè¿è¡Œ
    steps:
      - name: Announce Merge Deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: `ğŸš€ PR #${{ github.event.pull_request.number }} å·²åˆå¹¶åˆ° master ä¸”å¸¦æœ‰ 'deploy-when-merged' æ ‡ç­¾ã€‚å¼€å§‹éƒ¨ç½² master åˆ†æ”¯...\n[æŸ¥çœ‹ Workflow è¿è¡Œæƒ…å†µ](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });

      - name: Deploy Master Branch (On Merge with Label)
        shell: bash
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "PR #${PR_NUMBER} (åˆå¹¶ä¸”å¸¦æ ‡ç­¾) è§¦å‘éƒ¨ç½² master åˆ†æ”¯..."
          echo "å¯¼èˆªåˆ° /var/www/voidix..."
          cd /var/www/voidix
          if [ $? -ne 0 ]; then echo "é”™è¯¯ï¼šæ— æ³•è¿›å…¥ç›®å½• /var/www/voidixã€‚"; exit 1; fi

          echo "ä» origin æ‹‰å– master åˆ†æ”¯çš„æœ€æ–°æ›´æ”¹..."
          git fetch origin master
          if [ $? -ne 0 ]; then echo "é”™è¯¯ï¼šgit fetch origin master å¤±è´¥ã€‚"; exit 1; fi

          echo "æ£€å‡ºå¹¶å°†æœ¬åœ° master åˆ†æ”¯é‡ç½®ä¸º origin/master..."
          git checkout -B master origin/master
          if [ $? -ne 0 ]; then echo "é”™è¯¯ï¼šgit checkout -B master origin/master å¤±è´¥ã€‚"; exit 1; fi
          echo "æˆåŠŸå°† /var/www/voidix æ›´æ–°åˆ° master åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚"

          echo "é‡æ–°åŠ è½½ Nginx..."
          sudo systemctl reload nginx
          if [ $? -ne 0 ]; then echo "é”™è¯¯ï¼šé‡æ–°åŠ è½½ Nginx å¤±è´¥ã€‚è¯·æ£€æŸ¥ sudo æƒé™ã€‚"; exit 1; fi
          echo "Nginx å·²æˆåŠŸé‡æ–°åŠ è½½ã€‚Master åˆ†æ”¯å·²éƒ¨ç½²å®Œæ¯•ã€‚"

      - name: Remove Label and Post Merge Deployment Success Comment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            try { // å°è¯•ç§»é™¤æ ‡ç­¾ï¼Œå³ä½¿å¤±è´¥ä¹Ÿç»§ç»­è¯„è®º
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'deploy-when-merged'
              });
            } catch (error) {
              console.error(`ç§»é™¤æ ‡ç­¾ 'deploy-when-merged' å¤±è´¥: ${error.message}`);
              // ä¸ä¸­æ–­æµç¨‹ï¼Œç»§ç»­è¯„è®º
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ğŸ‰ éƒ¨ç½²æˆåŠŸï¼PR #${prNumber} åˆå¹¶åˆ° master çš„æ›´æ”¹å·²éƒ¨ç½²ã€‚\næ ‡ç­¾ 'deploy-when-merged' å·²å°è¯•ç§»é™¤ã€‚\n[æŸ¥çœ‹ Workflow è¿è¡Œæ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });

      - name: Post Merge Deployment Failure Comment
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: `ğŸ”¥ éƒ¨ç½²å¤±è´¥ï¼åœ¨éƒ¨ç½² PR #${{ github.event.pull_request.number }} åˆå¹¶åˆ° master çš„æ›´æ”¹æ—¶å‘ç”Ÿé”™è¯¯ã€‚\næ ‡ç­¾ 'deploy-when-merged' ä»ç„¶å­˜åœ¨ã€‚è¯·æ£€æŸ¥é—®é¢˜æˆ–æ‰‹åŠ¨ç§»é™¤æ ‡ç­¾åé‡è¯•ã€‚\nè¯·æ£€æŸ¥ [Workflow è¿è¡Œæ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ã€‚`
            }); 