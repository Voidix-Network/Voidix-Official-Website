name: Advanced PR Deployment Controller

on:
  issue_comment:
    types: [created]
  workflow_dispatch:  # 添加手动触发选项

permissions:
  contents: read
  issues: write       # 用于评论
  pull-requests: write # 用于添加/移除标签

jobs:
  deploy:
    name: 通过评论触发部署
    if: (github.event_name == 'issue_comment' && github.event.comment.body == 'deploy') || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/master')
    runs-on: [self-hosted, website]
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: 检查评论者权限
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        id: permission
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const auth = context.payload.comment.author_association;
            if (!['OWNER','MEMBER'].includes(auth)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `❌ 您(${auth}) 无权限触发部署。`
              });
              core.setFailed('权限不足');
            }
            
      - name: 获取PR信息
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        id: pr
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const prNumber = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({ 
              owner: context.repo.owner, 
              repo: context.repo.repo, 
              pull_number: prNumber 
            });
            if (!pr.merged || pr.base.ref !== 'master') {
              await github.rest.issues.createComment({ 
                owner: context.repo.owner, 
                repo: context.repo.repo, 
                issue_number: prNumber, 
                body: `ℹ️ PR #${prNumber} 未合并到 master，无法部署。` 
              });
              core.setFailed('PR 未合并');
            }
            
      - name: 执行部署脚本
        run: |
          chmod +x ./deploy.sh
          sudo ./deploy.sh
          
      - name: 部署完成反馈
        if: success() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ 部署成功完成: https://voidix.top`
            });
            
      - name: 部署成功日志
        if: success()
        run: |
          echo "✅ 部署成功完成: https://voidix.top"
          
      - name: 部署失败反馈
        if: failure() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `❌ 部署失败，请检查日志。`
            });
            
      - name: 📊 部署结果日志
        if: always()
        run: |
          echo "❌ 部署失败，请检查日志。"
