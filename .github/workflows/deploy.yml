name: Website Deployment

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½²'
        required: false
        default: false
        type: boolean
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '18'
  NGINX_WEB_ROOT: /var/www/voidix.net
  BACKUP_DIR: /var/backups/voidix-website
  DEPLOY_USER: www-data
  DEPLOY_GROUP: www-data
  COMMENT_BODY: ${{ github.event.comment.body }}

jobs:
  # æ™ºèƒ½å˜æ›´æ£€æµ‹ - æ”¯æŒå¤šæäº¤PR
  changes-detection:
    name: ğŸ” æ™ºèƒ½å˜æ›´æ£€æµ‹
    runs-on: [self-hosted, website]
    outputs:
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
      changes-summary: ${{ steps.changes.outputs.changes-summary }}
      total-changes: ${{ steps.changes.outputs.total-changes }}
      
    steps:
      - name: ğŸ”§ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œæ”¯æŒå¤šæäº¤PRæ£€æµ‹
          
      - name: ğŸ“Š æ™ºèƒ½å˜æ›´æ£€æµ‹ (æ”¯æŒå¤šæäº¤PR)
        id: changes
        run: |
          echo "=== å¼€å§‹æ™ºèƒ½å˜æ›´æ£€æµ‹ (æ”¯æŒå¤šæäº¤PR) ==="
          
          # ç¡®å®šåŸºå‡†æäº¤ï¼ˆå¯¹æ¯”çš„èµ·ç‚¹ï¼‰- æ”¯æŒå¤šç§è§¦å‘åœºæ™¯
          case "${{ github.event_name }}" in
            "push")
              # æ¨é€äº‹ä»¶ï¼šæ£€æŸ¥å½“å‰æ¨é€çš„æ‰€æœ‰æäº¤
              if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
                BASE_COMMIT="${{ github.event.before }}"
                echo "ğŸ”„ æ¨é€äº‹ä»¶ - åŸºå‡†æäº¤: $BASE_COMMIT"
                echo "ğŸ“ æ£€æµ‹æ¨é€ä¸­çš„æ‰€æœ‰æäº¤å˜æ›´"
              else
                # æ–°åˆ†æ”¯çš„æƒ…å†µï¼Œæ£€æŸ¥æœ€è¿‘1ä¸ªæäº¤
                BASE_COMMIT="HEAD~1"
                echo "ğŸ†• æ–°åˆ†æ”¯æ¨é€ - æ£€æŸ¥æœ€è¿‘1ä¸ªæäº¤"
              fi
              ;;
            "pull_request")
              # PRäº‹ä»¶ï¼šæ£€æŸ¥PRä¸­çš„æ‰€æœ‰å˜æ›´ (æ”¯æŒå¤šæäº¤)
              BASE_COMMIT="${{ github.event.pull_request.base.sha }}"
              echo "ğŸ”€ PRäº‹ä»¶ - åŸºå‡†æäº¤: $BASE_COMMIT"
              echo "ğŸ“¦ PR #${{ github.event.pull_request.number }} åŒ…å«å¤šä¸ªæäº¤ï¼Œæ£€æµ‹æ‰€æœ‰å˜æ›´"
              echo "ğŸ¯ ç›®æ ‡åˆ†æ”¯: ${{ github.event.pull_request.base.ref }}"
              echo "ğŸŒ¿ æºåˆ†æ”¯: ${{ github.event.pull_request.head.ref }}"
              ;;
            "workflow_dispatch")
              # æ‰‹åŠ¨è§¦å‘ï¼šå¯é€‰æ‹©å¼ºåˆ¶éƒ¨ç½²æˆ–æ£€æŸ¥æœ€è¿‘æäº¤
              if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
                echo "ğŸš€ æ‰‹åŠ¨å¼ºåˆ¶éƒ¨ç½²æ¨¡å¼"
                echo "should-deploy=true" >> $GITHUB_OUTPUT
                echo "changes-summary=æ‰‹åŠ¨å¼ºåˆ¶éƒ¨ç½²" >> $GITHUB_OUTPUT
                echo "total-changes=0" >> $GITHUB_OUTPUT
                exit 0
              else
                BASE_COMMIT="HEAD~1"
                echo "ğŸ›ï¸ æ‰‹åŠ¨è§¦å‘ - æ£€æŸ¥æœ€è¿‘1ä¸ªæäº¤"
              fi
              ;;
              "issue_comment")
              # è¯„è®ºè§¦å‘ï¼šæ£€æŸ¥æœ€è¿‘æäº¤
              # ä½¿ç”¨å…¨å±€ç¯å¢ƒå˜é‡ COMMENT_BODY ä»¥é˜²æ­¢ä»£ç æ³¨å…¥
              if [[ "$COMMENT_BODY" =~ deploy ]]; then
                BASE_COMMIT="HEAD~1"
                echo "ğŸ’¬ è¯„è®ºè§¦å‘éƒ¨ç½² - æ£€æŸ¥æœ€è¿‘1ä¸ªæäº¤"
              else
                echo "âŒ è¯„è®ºä¸åŒ…å«éƒ¨ç½²æŒ‡ä»¤"
                echo "should-deploy=false" >> $GITHUB_OUTPUT
                exit 0
              fi
              ;;
            *)
              echo "âš ï¸ æœªçŸ¥è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
              BASE_COMMIT="HEAD~1"
              ;;
          esac
          
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨ (å¤šæäº¤PRæ”¯æŒ)
          echo "ğŸ” æ£€æµ‹ $BASE_COMMIT åˆ° HEAD ä¹‹é—´çš„å˜æ›´..."
          CHANGED_FILES=$(git diff --name-only "$BASE_COMMIT" HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "changes-summary=æ— æ–‡ä»¶å˜æ›´" >> $GITHUB_OUTPUT
            echo "total-changes=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ“‹ å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨:"
          echo "$CHANGED_FILES" | sed 's/^/  ğŸ“„ /'
          
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦éƒ¨ç½²çš„æ–‡ä»¶å˜æ›´
          DEPLOY_WORTHY_PATTERN='\.(html|css|js|json|yml|yaml|sh)$|^assets/|^scripts/|^build-entries/|webpack\.config\.js|package\.json'
          DEPLOY_WORTHY_CHANGES=$(echo "$CHANGED_FILES" | grep -E "$DEPLOY_WORTHY_PATTERN" || true)
          
          # ç»Ÿè®¡å˜æ›´
          TOTAL_CHANGES=$(echo "$CHANGED_FILES" | wc -l)
          echo "total-changes=$TOTAL_CHANGES" >> $GITHUB_OUTPUT
          
          if [ -n "$DEPLOY_WORTHY_CHANGES" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°éœ€è¦éƒ¨ç½²çš„æ–‡ä»¶å˜æ›´:"
            echo "$DEPLOY_WORTHY_CHANGES" | sed 's/^/  ğŸ”§ /'
            
            # åˆ†ç±»ç»Ÿè®¡å¹¶æ˜¾ç¤ºå˜æ›´ç±»å‹
            HTML_CHANGES=$(echo "$DEPLOY_WORTHY_CHANGES" | grep '\.html$' | wc -l)
            CSS_CHANGES=$(echo "$DEPLOY_WORTHY_CHANGES" | grep '\.css$' | wc -l)
            JS_CHANGES=$(echo "$DEPLOY_WORTHY_CHANGES" | grep '\.js$' | wc -l)
            CONFIG_CHANGES=$(echo "$DEPLOY_WORTHY_CHANGES" | grep -E '\.(json|yml|yaml)$|webpack\.config\.js' | wc -l)
            ASSET_CHANGES=$(echo "$DEPLOY_WORTHY_CHANGES" | grep '^assets/' | wc -l)
            SCRIPT_CHANGES=$(echo "$DEPLOY_WORTHY_CHANGES" | grep '^scripts/' | wc -l)
            
            # æ„å»ºå˜æ›´æ‘˜è¦
            SUMMARY_PARTS=()
            [ "$HTML_CHANGES" -gt 0 ] && SUMMARY_PARTS+=("HTML:$HTML_CHANGES")
            [ "$CSS_CHANGES" -gt 0 ] && SUMMARY_PARTS+=("CSS:$CSS_CHANGES")
            [ "$JS_CHANGES" -gt 0 ] && SUMMARY_PARTS+=("JS:$JS_CHANGES")
            [ "$CONFIG_CHANGES" -gt 0 ] && SUMMARY_PARTS+=("é…ç½®:$CONFIG_CHANGES")
            [ "$ASSET_CHANGES" -gt 0 ] && SUMMARY_PARTS+=("èµ„æº:$ASSET_CHANGES")
            [ "$SCRIPT_CHANGES" -gt 0 ] && SUMMARY_PARTS+=("è„šæœ¬:$SCRIPT_CHANGES")
            
            CHANGES_SUMMARY=$(IFS=,; echo "${SUMMARY_PARTS[*]}")
            echo "changes-summary=$CHANGES_SUMMARY" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š å˜æ›´ç»Ÿè®¡:"
            [ "$HTML_CHANGES" -gt 0 ] && echo "  ğŸŒ HTMLæ–‡ä»¶: $HTML_CHANGES ä¸ª"
            [ "$CSS_CHANGES" -gt 0 ] && echo "  ğŸ¨ CSSæ–‡ä»¶: $CSS_CHANGES ä¸ª"
            [ "$JS_CHANGES" -gt 0 ] && echo "  âš¡ JavaScriptæ–‡ä»¶: $JS_CHANGES ä¸ª"
            [ "$CONFIG_CHANGES" -gt 0 ] && echo "  âš™ï¸ é…ç½®æ–‡ä»¶: $CONFIG_CHANGES ä¸ª"
            [ "$ASSET_CHANGES" -gt 0 ] && echo "  ğŸ–¼ï¸ èµ„æºæ–‡ä»¶: $ASSET_CHANGES ä¸ª"
            [ "$SCRIPT_CHANGES" -gt 0 ] && echo "  ğŸ“œ è„šæœ¬æ–‡ä»¶: $SCRIPT_CHANGES ä¸ª"
            
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "changes-summary=ä»…æ–‡æ¡£å˜æ›´" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ä»…æ–‡æ¡£æˆ–å…¶ä»–éå…³é”®æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡éƒ¨ç½²"
            echo "ğŸ“„ å˜æ›´çš„æ–‡ä»¶ç±»å‹:"
            echo "$CHANGED_FILES" | sed 's/^/  ğŸ“ /'
          fi
          
          echo "ğŸ“ˆ å˜æ›´æ£€æµ‹å®Œæˆ: æ€»è®¡ $TOTAL_CHANGES ä¸ªæ–‡ä»¶"
  # å¿«é€Ÿè´¨é‡æ£€æŸ¥
  quality-checks:
    name: ğŸ§ª è´¨é‡æ£€æŸ¥
    runs-on: [self-hosted, website]
    needs: changes-detection
    if: needs.changes-detection.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ”§ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit
          
      - name: ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•
        run: npm run test:integration

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  deploy:
    name: ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
    runs-on: [self-hosted, website]
    needs: [changes-detection, quality-checks]
    if: |
      needs.changes-detection.outputs.should-deploy == 'true' &&
      ((github.event_name == 'push' && contains(fromJSON('["master", "main"]'), github.ref_name)) ||
       (github.event_name == 'workflow_dispatch') ||
       (github.event_name == 'issue_comment' && 
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)))
    
    timeout-minutes: 15
    
    steps:
      - name: ğŸ”§ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“¦ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ—ƒï¸ æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
            
      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ¨ æ„å»ºé¡¹ç›®
        run: npm run build
        
      - name: ğŸ“Š æ˜¾ç¤ºæ„å»ºç»“æœ
        run: |
          echo "=== æ„å»ºå®Œæˆ ==="
          echo "ğŸ“‹ å˜æ›´æ‘˜è¦: ${{ needs.changes-detection.outputs.changes-summary }}"
          echo "ğŸ“ˆ æ–‡ä»¶å˜æ›´æ•°: ${{ needs.changes-detection.outputs.total-changes }}"
          
          if [ -d "dist/css" ]; then
            echo "ğŸ¨ CSSæ„å»ºç»“æœ:"
            find dist/css -name "*.css" -exec sh -c 'echo "  $(basename "$1"): $(wc -c < "$1") bytes"' _ {} \;
          fi
          
      - name: ğŸ” æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ğŸš€ éƒ¨ç½²ä¿¡æ¯:"
          echo "  äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
          echo "  åˆ†æ”¯: ${{ github.ref_name }}"
          echo "  æäº¤: ${{ github.sha }}"
          echo "  å˜æ›´æ‘˜è¦: ${{ needs.changes-detection.outputs.changes-summary }}"
          
      - name: ğŸ“ è¯„è®ºç¡®è®¤å¼€å§‹éƒ¨ç½²
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ...\nğŸ“‹ å˜æ›´: ${{ needs.changes-detection.outputs.changes-summary }}\nğŸ“¦ æäº¤: ${context.sha.substring(0, 7)}\nğŸ“ˆ æ€»æ–‡ä»¶æ•°: ${{ needs.changes-detection.outputs.total-changes }}`
            });

      - name: ğŸ” éªŒè¯éƒ¨ç½²ç¯å¢ƒ
        run: |
          echo "ğŸ”§ æ£€æŸ¥éƒ¨ç½²è„šæœ¬..."
          [ -f "./scripts/deploy-unified.js" ] || { echo "âŒ Node.jséƒ¨ç½²è„šæœ¬ç¼ºå¤±"; exit 1; }
          [ -f "./scripts/deploy.sh" ] || { echo "âŒ Bashéƒ¨ç½²è„šæœ¬ç¼ºå¤±"; exit 1; }
          echo "âœ… éƒ¨ç½²è„šæœ¬å®Œæ•´"
          
          echo "ğŸ’¾ æ£€æŸ¥ç³»ç»Ÿèµ„æº..."
          df -h / | tail -1 | awk '{print "ç£ç›˜ä½¿ç”¨ç‡: " $5}'
          
          echo "ğŸŒ æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          systemctl is-active nginx >/dev/null && echo "âœ… Nginxè¿è¡Œæ­£å¸¸" || echo "âš ï¸ NginxçŠ¶æ€å¼‚å¸¸"
          
          echo "ğŸ“ æ£€æŸ¥æ„å»ºç»“æœ..."
          [ -d "./dist" ] || { echo "âŒ distç›®å½•ä¸å­˜åœ¨"; exit 1; }
          echo "âœ… æ„å»ºæ–‡ä»¶å‡†å¤‡å°±ç»ª"

      - name: ğŸ¥ éƒ¨ç½²å‰å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²å‰å¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥å½“å‰ç½‘ç«™çŠ¶æ€
          if curl -f -s --max-time 10 https://voidix.net >/dev/null; then
            echo "âœ… å½“å‰ç½‘ç«™å¯æ­£å¸¸è®¿é—®"
          else
            echo "âš ï¸ å½“å‰ç½‘ç«™è®¿é—®å¼‚å¸¸ï¼Œç»§ç»­éƒ¨ç½²ä»¥ä¿®å¤"
          fi
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘ä¿ç•™1GBï¼‰
          available_kb=$(df / | tail -1 | awk '{print $4}')
          if [ "$available_kb" -lt 1048576 ]; then
            echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³: ${available_kb}KB"
            exit 1          fi
          echo "âœ… ç£ç›˜ç©ºé—´å……è¶³: ${available_kb}KB"

      - name: ğŸ“¦ ç¡®ä¿ Node.js ç¯å¢ƒ (éƒ¨ç½²ç”¨)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸš€ æ‰§è¡Œéƒ¨ç½²
        run: |
          echo "ğŸ”§ è®¾ç½®æ‰§è¡Œæƒé™..."
          chmod +x ./scripts/deploy.sh
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          deploy_start=$(date +%s)
          
          # æ‰§è¡Œéƒ¨ç½²
          if sudo -E ./scripts/deploy.sh; then
            deploy_end=$(date +%s)
            duration=$((deploy_end - deploy_start))
            echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼Œè€—æ—¶: ${duration}ç§’"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥"
            exit 1
          fi
          
      - name: âœ… éƒ¨ç½²åéªŒè¯
        run: |
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²åéªŒè¯..."
          
          # ç­‰å¾…æœåŠ¡ç¨³å®š
          sleep 5
          
          # éªŒè¯ç½‘ç«™å¯è®¿é—®æ€§
          max_attempts=5
          for attempt in $(seq 1 $max_attempts); do
            echo "ğŸŒ å°è¯•è®¿é—®ç½‘ç«™ (${attempt}/${max_attempts})..."
            
            if curl -f -s --max-time 10 https://voidix.net >/dev/null; then
              echo "âœ… ç½‘ç«™éªŒè¯æˆåŠŸ"
              break
            elif [ $attempt -eq $max_attempts ]; then
              echo "âŒ ç½‘ç«™éªŒè¯å¤±è´¥"
              exit 1
            else
              echo "â³ ç­‰å¾…æœåŠ¡é‡å¯..."
              sleep 10
            fi
          done
          
          # éªŒè¯å…³é”®é¡µé¢
          for page in "/" "/status.html" "/faq.html"; do
            if curl -f -s --max-time 10 "https://voidix.net${page}" >/dev/null; then
              echo "âœ… é¡µé¢éªŒè¯æˆåŠŸ: ${page}"
            else
              echo "âŒ é¡µé¢éªŒè¯å¤±è´¥: ${page}"
              exit 1
            fi
          done
          
      - name: ğŸ“Š éƒ¨ç½²ç»“æœæŠ¥å‘Š
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆ!"
            echo "ğŸŒ ç½‘ç«™åœ°å€: https://voidix.net"
            echo "ğŸ“‹ å˜æ›´æ‘˜è¦: ${{ needs.changes-detection.outputs.changes-summary }}"
            echo "ğŸ“ˆ å¤„ç†æ–‡ä»¶: ${{ needs.changes-detection.outputs.total-changes }} ä¸ª"
            echo "âš¡ å¤šæäº¤PRæ™ºèƒ½æ£€æµ‹: âœ… å·²ä¼˜åŒ–"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°æ—¥å¿—"
          fi
          
      - name: ğŸ’¬ è¯„è®ºéƒ¨ç½²ç»“æœ
        if: always() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
            const message = `ğŸš€ éƒ¨ç½²${status}\nğŸ“‹ å˜æ›´: ${{ needs.changes-detection.outputs.changes-summary }}\nğŸ“ˆ æ–‡ä»¶æ•°: ${{ needs.changes-detection.outputs.total-changes }}\nğŸŒ ç½‘ç«™: https://voidix.net`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

  # PRç¯å¢ƒé¢„è§ˆéƒ¨ç½² (ä»…ç”¨äºPR)
  preview-deploy:
    name: ğŸ” PRé¢„è§ˆéƒ¨ç½²
    runs-on: [self-hosted, website]
    needs: [changes-detection, quality-checks]
    if: |
      github.event_name == 'pull_request' &&
      needs.changes-detection.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ”§ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ¨ æ„å»ºé¢„è§ˆç‰ˆæœ¬
        run: npm run build
        
      - name: ğŸ’¬ PRè¯„è®ºé¢„è§ˆä¿¡æ¯
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ” **PRé¢„è§ˆæ„å»ºå®Œæˆ**\nğŸ“‹ å˜æ›´æ‘˜è¦: ${{ needs.changes-detection.outputs.changes-summary }}\nğŸ“ˆ æ–‡ä»¶å˜æ›´: ${{ needs.changes-detection.outputs.total-changes }} ä¸ª\nâš¡ **å¤šæäº¤PRæ”¯æŒ**: å·²æ£€æµ‹åˆ°PRä¸­çš„æ‰€æœ‰æäº¤å˜æ›´\n\nâœ… æ„å»ºæˆåŠŸï¼Œå‡†å¤‡å¥½åˆå¹¶åˆ°ä¸»åˆ†æ”¯`
            });
